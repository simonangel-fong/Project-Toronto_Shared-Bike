pipeline {
    agent any

    environment {
        COMPOSE_PATH = "oracledb/compose.oracledb.prod.yaml"
        ORACLE_CONTAINER_NAME = "oracle19cDB"
        PDB_NAME = "TORONTO_SHARED_BIKE"
    }

    triggers {
        pollSCM('H/5 * * * *') // Poll every 5 minutes
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'feature-oracledb', url: 'https://github.com/simonangel-fong/Project-Toronto_Shared-Bike.git'
            }
        }

        stage('Start Oracle DB Container') {
            steps {
                sh "docker-compose -f ${COMPOSE_PATH} up -d"
            }
        }

        stage('Wait for Oracle DB Health') {
            steps {
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        waitUntil {
                            def health = sh(
                                script: "docker inspect --format='{{.State.Health.Status}}' ${ORACLE_CONTAINER_NAME}",
                                returnStdout: true
                            ).trim()
                            echo "Health status: ${health}"
                            return (health == 'healthy')
                        }
                    }
                }
            }
        }

        stage('Verify PDB Existence') {
            steps {
                script {
                    def sqlOutput = sh(
                        script: """
                            docker exec ${ORACLE_CONTAINER_NAME} bash -c \\
                            "echo \\"SELECT name FROM v\\\$pdbs WHERE name = '${PDB_NAME}';\\" | \\
                            sqlplus -S sys/\\\$(cat /run/secrets/orcl_sys_token)@ORCLCDB as sysdba"
                        """,
                        returnStdout: true
                    ).trim()

                    if (!sqlOutput.contains("${PDB_NAME}")) {
                        error("‚ùå PDB '${PDB_NAME}' NOT FOUND!")
                    } else {
                        echo "‚úÖ PDB '${PDB_NAME}' exists."
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning up Docker containers...'
            sh "docker-compose -f ${COMPOSE_PATH} down"
        }
    }
}
