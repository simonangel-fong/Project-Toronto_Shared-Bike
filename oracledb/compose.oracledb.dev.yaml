# docker compose for development Windows OS
name: toronto-shared-bike

services:
  oracle19cDB-dev:
    container_name: oracle19cDB-dev
    restart: unless-stopped
    image: simonangelfong/oracledb19c:1.0
    # image: simonangelfong/toronto-shared-bike-db-prebuilt:year2019 # using prebuild image
    env_file:
      - ./env/dev.env
    environment:
      # - ORACLE_SID=${ORCLDB_SID}
      - ORACLE_PWD=/run/secrets/orcl_sys_token
    secrets:
      - orcl_sys_token
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 8g
        reservations:
          memory: 4g
    volumes:
      - ./scripts/setup:/opt/oracle/scripts/setup # script to run after setup
      - ./scripts:/project/scripts # scripts
      # dev volumes
      - oracledata:/opt/oracle/oradata # persist data
      - ../project/data:/project/data # source data
      - ../project/orabackup:/project/orabackup # local backup
      - ../project/nfsbackup:/project/nfsbackup # remote backup
      # prod volumes
      # - /project/oradata:/opt/oracle/oradata # prod: persist data
      # - /project/data:/project/data # source data
      # - /project/orabackup:/project/orabackup # prod: backup data
      # - /project/nfsbackup:/project/nfsbackup # prod: remote backup data
    networks:
      - private-net # Private network for prod
      - public-net # public for dev
    ports:
      - 1521:1521
    healthcheck:
      test:
        [
          "CMD",
          "sqlplus",
          "-S",
          "sys/${ORACLE_PWD}@${ORACLE_SID}",
          "as",
          "sysdba",
          "<<<",
          "exit",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5m

volumes:
  oracledata:

networks:
  public-net:
    driver: bridge
  private-net:
    driver: bridge
    internal: true

secrets:
  orcl_sys_token:
    file: ./env/orcl_sys_token.txt
